name: Agent Implement

on:
  issues:
    types: [labeled]

jobs:
  implement:
    if: github.event.label.name == 'ai:implement'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # 001-001: Label swap
      - name: Remove ai:implement label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ai:implement'
            });

      - name: Add ai:in-progress label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ai:in-progress']
            });

      # 001-002: Checkout and branch creation
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate branch name
        id: branch
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const title = context.payload.issue.title;
            const slug = title
              .toLowerCase()
              .replace(/[^a-z0-9\s-]/g, '')
              .trim()
              .split(/\s+/)
              .slice(0, 5)
              .join('-');
            return `agent/issue-${context.issue.number}-${slug}`;

      - name: Create and checkout branch
        run: |
          git checkout -b "${{ steps.branch.outputs.result }}"

      # 001-003: Claude Code execution
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude --print "${{ github.event.issue.title }}

          ${{ github.event.issue.body }}"

      # 001-004: Commit changes and open PR
      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure git
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "[Agent] feat: implement changes for issue #${{ github.event.issue.number }}"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.branch.outputs.result }}"

      - name: Create pull request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;

            // Truncate title to fit 72 char limit
            const prefix = `Fixes #${issueNumber}: `;
            const maxTitleLen = 72 - prefix.length;
            const truncatedTitle = issueTitle.length > maxTitleLen
              ? issueTitle.slice(0, maxTitleLen - 3) + '...'
              : issueTitle;

            const prTitle = `${prefix}${truncatedTitle}`;

            const prBody = [
              '## Summary',
              '',
              `Agent implementation for issue #${issueNumber}.`,
              '',
              '## Changes',
              '',
              '- Implemented changes as requested in the issue',
              '',
              '## Implementation Notes',
              '',
              'This PR was automatically generated by the AI agent.',
              '',
              `Closes #${issueNumber}`
            ].join('\n');

            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              body: prBody,
              head: '${{ steps.branch.outputs.result }}',
              base: '${{ github.event.repository.default_branch }}'
            });
